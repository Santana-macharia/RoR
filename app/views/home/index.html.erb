<!DOCTYPE html>
<html>
<head>
    <title>MapFiend - Home</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">MapFiend</a>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#">Page 1</a></li>
                <li><a href="#">Page 2</a></li>
                <li><a href="#">Page 3</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                <li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
            </ul>
        </div>
    </nav>

    <div id="map" style="width: 80%; height: 500px; margin: auto; margin-top: 75px;"></div>
</body>
<script>
    function myMap() {
        var mapCanvas = document.getElementById("map");
        var mapOptions = {
            center: new google.maps.LatLng(40.691, -75.214),
            zoom: 13
        };
        var map = new google.maps.Map(mapCanvas, mapOptions);

        console.log('Getting points...');
        //placeMarkers(map, getMarkersFromDB());
        getMarkersFromDB(placeMarkers, map)
        console.log('Got points');

        google.maps.event.addListener(map, 'click', function(event) {
            placeMarker(map, event.latLng);
            insertMarkerToDB(event.latLng, 'test');
        });

        function placeMarkers(map, points) {
            console.log('placeMarkers() called with # points = ' + points.length);
            points.forEach(function(point) {
                console.log('placing point: ' + JSON.stringify(point));
                var location = {
                    lat: Number(point.latitude),
                    lng: Number(point.longitude)
                };
                console.log('placing at location: ' + location);
                placeMarker(map, location);
            });
        }

        function placeMarker(map, location) {
            var marker = new google.maps.Marker({
                position: location,
                map: map
            });
        }

        function insertMarkerToDB(location, name) {
            $.ajax({
                type: 'GET',
                url: '/MapPoint/create.json',
                data: {
                    latitude: location.lat,
                    longitude: location.lng,
                    name: name
                },
                success: function(data) {
                    console.log('RESULT: ' + JSON.stringify(data));
                }
            });
        }

        function getMarkersFromDB(callback, map) {
            $.ajax({
                type: 'GET',
                url: '/MapPoint/all.json',
                success: function(data) {
                    console.log('getMarkersFromDB() returns ' + data.points.length + ' points');
                    callback(map, data.points);
                }
            })
        }
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?callback=myMap"></script>
</html>
